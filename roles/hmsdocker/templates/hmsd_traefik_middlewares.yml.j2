http:
  middlewares:
    internal-secured:
      chain:
        middlewares:
          - internal-ipallowlist
          - https-only
          - secure-headers

    external-secured:
      chain:
        middlewares:
          - external-ipallowlist
          - https-only
          - secure-headers

    https-only:
      redirectScheme:
        scheme: https
        permanent: true

    secure-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        allowedHosts: 
        {% for host in traefik_enabled_subdomains %}
          - "{{ host }}.{{ hms_docker_domain }}"
        {% endfor %}

    internal-ipallowlist:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"
        {% for address in traefik_subnet_allow_list | regex_replace(', ', ',') | split(',') %}
          - "{{ address }}"
        {% endfor %}

    external-ipallowlist:
      ipAllowList:
        sourceRange:
          - "0.0.0.0/0"
    {% if hmsdocker_authentik_enabled_through_cftunnel %}
    cloudflarewarp:
      plugin:
        cloudflarewarp:
          disableDefault: false
          trustip: # Trust IPS not required if disableDefault is false - we will add Cloudflare IPs automatically
            - "2400:cb00::/32"
    {% endif %}
